<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FleetShield AI - MyGeotab Add-In</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0f1a; }
    .addin-container { width: 100%; height: 100vh; position: relative; }
    iframe { width: 100%; height: 100%; border: none; }
    .loading {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      background: #0a0f1a; color: #10b981; font-size: 1.2rem; z-index: 10;
    }
    .loading.hidden { display: none; }
  </style>
</head>
<body>
  <div class="addin-container">
    <div class="loading" id="loading">Loading FleetShield AI...</div>
    <iframe id="dashboard-frame" src="" allow="microphone"></iframe>
  </div>

  <script>
    // MyGeotab Add-In bridge
    // The geotab object is injected by MyGeotab
    (function() {
      let geotabApi = null;

      // Called by MyGeotab when the add-in is loaded
      window.geotab = window.geotab || {};

      window.geotab.addin = window.geotab.addin || {};
      window.geotab.addin.fleetshieldAi = function(api, state) {
        geotabApi = api;

        // Set dashboard URL - in production this would be your hosted URL
        const dashboardUrl = getDashboardUrl();
        document.getElementById('dashboard-frame').src = dashboardUrl;
        document.getElementById('dashboard-frame').onload = function() {
          document.getElementById('loading').classList.add('hidden');
          // Pass Geotab session info to dashboard via postMessage
          if (state && state.credentials) {
            document.getElementById('dashboard-frame').contentWindow.postMessage({
              type: 'geotab-session',
              database: state.credentials.database,
              userName: state.credentials.userName,
              sessionId: state.credentials.sessionId,
              server: state.credentials.server,
            }, '*');
          }
        };
      };

      // Listen for messages from the dashboard iframe
      window.addEventListener('message', function(event) {
        if (!geotabApi) return;

        const msg = event.data;
        if (msg.type === 'geotab-api-call') {
          // Proxy Geotab API calls from dashboard through the authenticated session
          geotabApi.call(msg.method, msg.params, function(result) {
            event.source.postMessage({
              type: 'geotab-api-result',
              callId: msg.callId,
              result: result,
            }, '*');
          }, function(error) {
            event.source.postMessage({
              type: 'geotab-api-error',
              callId: msg.callId,
              error: error.message || String(error),
            }, '*');
          });
        }

        if (msg.type === 'geotab-ace-query') {
          // Proxy Ace queries
          geotabApi.call('CreateChatCompletionAsync', {
            prompt: msg.prompt,
            customerData: true,
          }, function(result) {
            event.source.postMessage({
              type: 'geotab-ace-result',
              callId: msg.callId,
              result: result,
            }, '*');
          }, function(error) {
            event.source.postMessage({
              type: 'geotab-ace-error',
              callId: msg.callId,
              error: error.message || String(error),
            }, '*');
          });
        }
      });

      function getDashboardUrl() {
        // In development: localhost. In production: your hosted URL.
        // Check if running locally
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          return 'http://localhost:3000';
        }
        // Production URL (replace with your actual deployed URL)
        return 'https://fleetshield-ai.vercel.app';
      }
    })();
  </script>
</body>
</html>
